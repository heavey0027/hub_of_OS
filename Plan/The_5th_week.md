
### 第5周：中断和异常处理（4月25日–5月1日）

**需求分析**

- **目标**：实现Trap机制处理中断和异常。
- **功能需求**：
  - 处理RISC-V基础中断（例如定时器）。
  - 设置异常处理器处理非法指令。
- **非功能需求**：确保中断处理不导致内核崩溃。

**系统设计**

- **组件**：

  - Trap处理器：汇编代码保存/恢复寄存器并分派到C处理器。
  - 定时器中断：处理周期性中断。

- **图示**：

  ```
  [中断] -> [Trap处理器（汇编）] -> [C处理器] -> [返回]
  ```

**实现细节**

- 编写`trap.S`处理Trap进入/退出。

- 实现简单的定时器中断处理器。

- **关键代码**：

  ```assembly
  # trap.S
  .global trap_entry
  trap_entry:
      csrw mscratch, sp
      li sp, 0x80010000  # Trap堆栈
      addi sp, sp, -128  # 保存寄存器
      call trap_handler
      mret
  ```

  ```c
  // trap.c
  void trap_handler() {
      uint64_t mcause = read_mcause();
      if (mcause == 0x8000000000000007) { // 定时器中断
          uart_putc('T');
          clear_timer();
      }
  }
  ```

**测试结果**

- **测试用例**：触发定时器中断，验证处理器输出。
- **结果**：定时器中断触发，控制台输出'T'。
- **截图**：QEMU输出显示周期性'T'字符。

**总结与反思**

- **成果**：成功处理定时器中断。
- **挑战**：理解RISC-V CSR寄存器较难，通过文档解决。
- **改进建议**：下周实现系统调用。