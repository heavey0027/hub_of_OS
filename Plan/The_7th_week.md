
### 第7周：用户程序加载和执行（5月9日–5月15日）

**需求分析**

- **目标**：加载并执行简单用户程序（例如打印“Hello World”）。
- **功能需求**：
  - 将ELF二进制文件加载到内存。
  - 切换到用户模式并执行程序。
- **非功能需求**：确保内核与用户空间隔离。

**系统设计**

- **组件**：

  - ELF加载器：解析ELF头部并加载段。
  - 用户模式切换：设置用户堆栈并使用`mret`切换到用户模式。

- **图示**：

  ```
  [ELF文件] -> [加载器] -> [用户内存] -> [mret到用户模式]
  ```

**实现细节**

- 实现基础ELF加载器解析程序头部。

- 在`trap.S`中设置用户模式转换。

- **关键代码**：

  ```c
  // elf.c
  void load_elf(char *elf_data) {
      // 简化：加载程序到固定地址
      memcpy((void *)0x80020000, elf_data, elf_size);
  }
  ```

**测试结果**

- **测试用例**：加载并运行调用`sys_write`的用户程序。
- **结果**：程序加载成功，但在`mret`处崩溃，因页面表设置不完整。
- **截图**：调试输出显示ELF加载但用户模式切换崩溃。

**总结与反思**

- **成果**：部分实现ELF加载器。
- **挑战**：用户模式转换因页面表问题失败。
- **改进建议**：下周调试用户模式并测试系统调用