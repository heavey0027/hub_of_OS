
### 第4周：基础内存管理（4月18日–4月24日）

**需求分析**

- **目标**：实现物理内存分配和基础页面表设置。
- **功能需求**：
  - 使用简单分配器（例如位图或伙伴系统）分配物理内存。
  - 初始化简单的页面表支持虚拟内存。
- **非功能需求**：确保内存分配高效且无错误。

**系统设计**

- **组件**：

  - 内存分配器：基于位图的物理页面分配器。
  - 页面表：单级页面表，简单易实现。

- **图示**：

  ```
  [内核] -> [位图分配器] -> [物理内存]
           -> [页面表设置] -> [虚拟内存]
  ```

**实现细节**

- 实现位图分配器跟踪空闲物理页面。

- 设置基础页面表，将内核代码映射到虚拟地址。

- **关键代码**：

  ```c
  // mem.c
  #define PAGE_SIZE 4096
  #define MEM_SIZE (1 << 20) // 1MB
  char bitmap[MEM_SIZE / PAGE_SIZE / 8];
  void *alloc_page() {
      for (int i = 0; i < MEM_SIZE / PAGE_SIZE; i++) {
          if (!(bitmap[i / 8] & (1 << (i % 8)))) {
              bitmap[i / 8] |= (1 << (i % 8));
              return (void *)(i * PAGE_SIZE);
          }
      }
      return NULL;
  }
  ```

**测试结果**

- **测试用例1**：分配和释放页面，验证位图更新。
  - **结果**：成功分配并释放10个页面。
- **测试用例2**：启用页面表启动内核。
  - **结果**：内核启动，但页面表映射不完整（需调试）。
- **截图**：调试输出显示分配的页面地址。

**总结与反思**

- **成果**：实现基础内存分配器。
- **挑战**：页面表设置复杂，因RISC-V知识有限，需进一步学习虚拟内存。
- **改进建议**：调试页面表问题，准备中断处理。
