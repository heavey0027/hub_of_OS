
### 第6周：系统调用框架（5月2日–5月8日）

**需求分析**

- **目标**：实现`write`和`exit`系统调用接口。
- **功能需求**：
  - 支持用户程序调用`write`输出文本。
  - 支持`exit`终止程序。
- **非功能需求**：确保系统调用安全高效。

**系统设计**

- **组件**：

  - 系统调用分派器：根据系统调用号路由。
  - 系统调用处理器：实现`sys_write`和`sys_exit`。

- **图示**：

  ```
  [用户程序] -> [ecall] -> [Trap处理器] -> [系统调用分派器] -> [处理器]
  ```

**实现细节**

- 修改`trap.S`检测`ecall`指令。

- 实现`sys_write`输出到UART。

- **关键代码**：

  ```c
  // syscall.c
  void syscall_dispatch(uint64_t syscall_num, uint64_t arg0) {
      if (syscall_num == 1) { // sys_write
          char *buf = (char *)arg0;
          while (*buf) uart_putc(*buf++);
      }
  }
  ```

**测试结果**

- **测试用例**：编写用户程序调用`sys_write`。
- **结果**：因缺少用户模式支持测试失败（下周实现）。
- **截图**：内核输出显示系统调用进入但无用户输出。

**总结与反思**

- **成果**：搭建系统调用框架。
- **挑战**：缺少用户模式支持导致测试受阻。
- **改进建议**：下周专注于用户程序执行。